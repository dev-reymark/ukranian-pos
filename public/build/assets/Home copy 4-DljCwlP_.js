import{r,j as e,Y as ue,c as S,a as de,b as pe,d as y}from"./app-DJ0OCxwK.js";import{Q as fe,X as xe,G as he,B as l}from"./index-CjPihSUo.js";import ge from"./MOPCard-5tvm-XkL.js";import{P as Se,b as ye}from"./POSKeyboard-CFvMiQVm.js";import{PumpCard as Ne}from"./PumpCard-zIFWhLTc.js";import{CustomerDetails as be}from"./CustomerDetails-BJXZp5Gz.js";import{PrinterStatus as Pe}from"./PrinterStatus-D_444F3t.js";import{GetCashier as je}from"./GetCashier-C70ZXMcB.js";import{GetDateTime as ve}from"./GetDateTime-DW6mrmFi.js";import{ThemeSwitcher as Oe}from"./ThemeSwitcher-CKD5WiPK.js";import De from"./Index-ChKOWB5U.js";import{CardDetails as Ce}from"./CardDetails-DNBVPHqk.js";import{SaleWindowTabs as we}from"./SaleWindowTabs-BZGo19Sl.js";import _e from"./ReportsIndex-CN4UZPvV.js";import{s as Ie}from"./chunk-IXXDDLGU-C927SSi6.js";import{i as Ae}from"./chunk-GQQM5TNQ-P53s9ApC.js";import{t as Fe,a as N}from"./chunk-FXLYF44B-CXo7bLYM.js";import"./iconBase-BN3XEKHS.js";import"./index-BOPwCyX4.js";import"./SelectionManager-CiNkBuTg.js";import"./FocusScope-C3BCnoq3.js";import"./scrollIntoView-D_ErU28Z.js";import"./useControlledState-DF6__fTM.js";import"./chunk-44JHHBS2-CWPKxyw1.js";import"./useLabel-BEN_EtuV.js";import"./useLabels-C7uuHIf4.js";import"./useCollator-BqR0K-ta.js";import"./useListState-BnYXW82J.js";import"./index-2TX6XvHX.js";import"./index-3GMhIGNj.js";import"./chunk-P2T5LMDM-BSwoEP5i.js";import"./getScrollParent-CTiUb1E9.js";import"./VisuallyHidden-D0N98OxW.js";import"./chunk-DBLREEYE-C6Vwu_wX.js";import"./chunk-2PIR7DFM-CbcDDgM_.js";import"./PumpDelivery-B3Qbs3Ap.js";import"./chunk-YRZGWF2W-AeXPm49x.js";import"./chunk-KBN3H6OQ-CWXvv_JV.js";import"./useToggleState-BTeDqN7Y.js";import"./useFormReset-Dic5pjzl.js";import"./chunk-CAFRINWI-BTDo8zfp.js";import"./useFormValidationState-cOo1klYh.js";import"./LiveAnnouncer-q_S9a73M.js";import"./useHasTabbableChild-Daxskigl.js";import"./Icon-C3UHRYlP.js";import"./PumpStatus-5SYFXcQO.js";import"./chunk-QXREVWCS-CzOl0UnF.js";import"./chunk-4WFLSIHH-DHr-3Ab-.js";import"./chunk-M3MASYO7-CeYIKs2S.js";import"./chunk-JHUBASYZ-BiB9buEj.js";import"./ElectricJournal-Cu1TpWAi.js";import"./index-EUbz-fhy.js";import"./index-D834aa3t.js";import"./index-X92CTFGl.js";import"./AboutSoftware-CVR7ZnrI.js";import"./ApplicationLogo-ynUf4uBI.js";import"./PriceChange-B4fw-xZt.js";import"./chunk-RUXXUVWM-Dvg1qZRs.js";import"./NumberFormatter-DgUnyrzU.js";import"./index-B3MhTQ63.js";function Jt(){const[K,Te]=r.useState([]),[b,d]=r.useState(""),[C,Q]=r.useState([]),[X,Y]=r.useState([]),[q,m]=r.useState(!1),[u,P]=r.useState(()=>{const t=localStorage.getItem("deliveryData");return t?JSON.parse(t):[]}),[p,w]=r.useState(null),[j,_]=r.useState(!1),[I,Z]=r.useState(!1),c=r.useRef(null),[A,Me]=r.useState([]),[ee,te]=r.useState(0),[ae,F]=r.useState(!1),[Re,se]=r.useState(0),[re,T]=r.useState(!1),[M,R]=r.useState(""),[k,E]=r.useState(""),[z,B]=r.useState(""),[G,V]=r.useState(""),[f,J]=r.useState(""),[x,L]=r.useState(""),[h,H]=r.useState(""),U=()=>{T(!1)},oe=()=>{U()},ne=t=>{P(a=>{const n=[...a,t];return localStorage.setItem("deliveryData",JSON.stringify(n)),n})},v=(t,a)=>{a==="success"?l.success(t):a==="error"&&l.error(t)},$=()=>{Z(!0),window.removeEventListener("click",$)};r.useEffect(()=>{window.addEventListener("click",$);const t=()=>{y.get("/get-pump-status").then(s=>{const i=s.data;Q(i);const o=i.some(D=>D.Data.NozzleUp);I&&(o&&!j?(c.current&&(c.current.loop=!0,c.current.play().catch(D=>{console.error("Error playing sound:",D)})),_(!0)):!o&&j&&(c.current&&(c.current.pause(),c.current.currentTime=0),_(!1)))}).catch(s=>{console.error("Error fetching pump status:",s)})},a=()=>{y.get("/get-mop").then(s=>{Y(s.data.data);const i=K.some(o=>o.MOP_Ref==="3");m(i)}).catch(s=>{console.error("Error fetching MOP list:",s)})};t(),a();const n=setInterval(t,500);return()=>clearInterval(n)},[j,I]);const ie=async t=>{console.log("MOP selected:",t);const a=parseFloat(b.replace("₱","").replace(",",""));if(b===""||a<=0){l.warning("Please enter an amount first.");return}const n=JSON.parse(localStorage.getItem("transaction"))||{subtotal:parseFloat(g),payments:[],remainingBalance:parseFloat(g)},s=n.remainingBalance-a;if(s>=0)n.payments.push({mopName:t.MOP_Name,amount:a}),n.remainingBalance=s,localStorage.setItem("transaction",JSON.stringify(n)),t.MOP_Ref==="3"?m(!0):s===0?await O():d(`Amount Due: ₱${s.toFixed(2)}`);else{const i=Math.abs(s).toFixed(2);l.success(`Change: ₱${i}`),n.payments.push({mopName:t.MOP_Name,amount:a}),n.remainingBalance=0,localStorage.setItem("transaction",JSON.stringify(n)),d(`Change: ₱${i}`),t.MOP_Ref==="3"?m(!0):await O()}},g=u.reduce((t,a)=>t+parseFloat(a.Amount||0),0).toFixed(2),[le,W]=r.useState({change:0,mopNames:[],mopPayments:[],deliveryData:[]}),ce=(t,a)=>{if(p==null){l.error("Please select an item to apply discount");return}if(t.discount_id>=1&&t.discount_id<=4){l.info("Discount not applicable");return}const n=u.map(s=>{if(s.Delivery_ID===p){if(s.DiscountedAmount)return l.info("Discount already applied to this item."),s;let i=0;switch(t==null?void 0:t.discount_type){case"1":i=parseFloat(s.Amount)*parseFloat(a==null?void 0:a.preset_value)/100;break;case"2":i=parseFloat(s.Volume)*parseFloat(a==null?void 0:a.preset_value);break;case"3":i=parseFloat(a==null?void 0:a.preset_value);break}const o=parseFloat(s.Amount)-i;return{...s,OriginalAmount:s.Amount,Amount:o.toFixed(2),DiscountedAmount:i.toFixed(2),PresetName:a==null?void 0:a.preset_name,DiscountType:t==null?void 0:t.discount_type,PresetValue:a==null?void 0:a.preset_value}}return s});P(n),l.success("Discount applied.")},O=async()=>{const t=JSON.parse(localStorage.getItem("transaction"));if(!t){l.error("No transaction found");return}if(A&&A.MOP_Ref==="3"&&(!f||!x||!h)){l.error("Please provide complete card details."),m(!0);return}const a=t.payments.reduce((s,i)=>s+i.amount,0),n=Math.max(0,a-t.subtotal).toFixed(2);try{const i=(await y.post("/store-transactions",{subtotal:t.subtotal,taxTotal:t.subtotal/1.12*.12,change:parseFloat(n),mopNames:t.payments.map(o=>o.mopName.trim()),mopPayments:t.payments,deliveryIds:u.map(o=>({Delivery_ID:o.Delivery_ID,Pump:o.Pump,Nozzle:o.Nozzle,Volume:o.Volume,Price:o.Price,Amount:o.Amount,OriginalAmount:o.OriginalAmount,DiscountedAmount:o.DiscountedAmount,DiscountType:o.DiscountType,PresetName:o.PresetName,PresetValue:o.PresetValue,FuelGradeName:o.FuelGradeName})),customer:{name:M,address:k,tin:z,businessStyle:G},cardDetails:{name:h,code:x,number:f}})).data.transaction;i?(localStorage.setItem("transactionId",i),l.success("Transaction saved"),F(!0),se(0),d("Transaction Complete"),W({change:parseFloat(n),mopNames:t.payments.map(o=>o.mopName),mopPayments:t.payments,deliveryData:u}),localStorage.removeItem("transaction"),J(""),L(""),H("")):l.error("Error retrieving transaction ID")}catch{l.error("Error saving transaction")}},me=async t=>{if(!t){l.info("Please transact first");return}try{const n=(await y.get(`/print-receipt/${t}`)).data}catch{l.error("Error fetching receipt data")}};return e.jsxs(e.Fragment,{children:[e.jsx(ue,{title:"Home"}),e.jsx("audio",{ref:c,src:"assets/audio/nozzle-status-sound.wav"}),e.jsxs("main",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 p-2 h-[100vh] bg-gradient-to-bl from-blue-100 via-transparent dark:from-blue-950 dark:via-transparent",children:[e.jsxs(S,{className:"dark:bg-gray-900 p-2",children:[e.jsx("div",{children:e.jsxs(S,{className:"max-w-full h-full",children:[e.jsxs(de,{className:"justify-between",children:[e.jsx(je,{}),e.jsx(ve,{})]}),e.jsx(pe,{className:"justify-between",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"w-[70%] h-[65px] bg-slate-200 rounded-lg shadow-sm relative",children:e.jsx(fe,{autoClose:2e3,hideProgressBar:!1,newestOnTop:!1,closeOnClick:!0,pauseOnFocusLoss:!1,draggable:!0,pauseOnHover:!1,theme:"light",transition:xe,style:{position:"absolute",top:0,right:0,bottom:0,left:0,width:"100%"}})}),e.jsx(Pe,{}),e.jsx(Oe,{})]})})]})}),e.jsx(Ie,{y:3}),e.jsx("div",{className:"flex-grow",children:e.jsx(we,{deliveryData:u,setSelectedRow:w,subtotal:g,transactionSaved:ae,transactionSummary:le})}),e.jsx("div",{children:e.jsxs(S,{className:"w-full gap-2 p-2",children:[e.jsx(Ae,{variant:"bordered",classNames:{input:["text-black text-2xl font-bold text-right"]},value:b,isReadOnly:!0,size:"lg"}),e.jsx(Se,{setDeliveryData:P,deliveryData:u,setSelectedRow:w,selectedRow:p,subtotal:g,onToast:v,buttons:ye,setInputValue:d,setTransactionSummary:W,setTransactionSaved:F,setCustomerModalOpen:T,setTotalPaid:te,totalPaid:ee,handlePrintReceipt:me})]})})]}),e.jsx(S,{className:"dark:bg-gray-900 p-2",children:e.jsx("div",{className:"flex w-full flex-col",children:e.jsxs(Fe,{"aria-label":"Pumps",fullWidth:!0,children:[e.jsx(N,{title:e.jsx("p",{className:"font-extrabold",children:"PUMPS"}),children:C.length===0?e.jsxs("div",{className:"col-span-4 flex flex-col items-center justify-center py-12 text-xl font-extrabold text-center text-red-500",children:[e.jsx(he,{className:"text-7xl"}),e.jsx("p",{children:"No pumps connected!"})]}):e.jsx("div",{className:"overflow-y-auto scrollbar-hide max-h-screen p-1",children:e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2",children:C.map(t=>e.jsx(Ne,{pump:t,handleAppendDeliveryData:ne,onToast:v},t.Id))})})},"pumps"),e.jsx(N,{title:e.jsx("p",{className:"font-extrabold",children:"MOP"}),children:e.jsx(ge,{mopList:X,onSelectMOP:ie,onApplyDiscount:ce})},"mop"),e.jsx(N,{title:e.jsx("p",{className:"font-extrabold",children:"REPORTS"}),children:e.jsx(_e,{})},"reports"),e.jsx(N,{title:e.jsx("p",{className:"font-extrabold",children:"CONFIG"}),children:e.jsx(De,{onToast:v})},"config")]})})})]}),e.jsx(be,{isOpen:re,onClose:U,onCustomerDataChange:(t,a)=>{switch(t){case"name":R(a);break;case"address":E(a);break;case"tin":B(a);break;case"businessStyle":V(a);break}},customerName:M,customerAddress:k,customerTIN:z,customerBusinessStyle:G,onSave:oe,setCustomerName:R,setCustomerAddress:E,setCustomerTIN:B,setCustomerBusinessStyle:V}),e.jsx(Ce,{isOpen:q,onOpenChange:m,cardNumber:f,setCardNumber:J,approvalCode:x,setApprovalCode:L,cardHolderName:h,setCardHolderName:H,onSave:async()=>{if(!f||!x||!h){l.error("Please fill in all card details.");return}m(!1),await O()}})]})}export{Jt as default};
