import{r,j as t,Y as be,a as m}from"./app-DLbhLsOv.js";import{S as ve}from"./sweetalert2.all-CP75QBKc.js";import{Q as we,X as je,G as Pe,B as n}from"./index-psrdvPuR.js";import Oe from"./MOPCard-28g9pbsW.js";import Ce,{buttons as De}from"./POSKeyboard-CM4ksF7I.js";import{PumpCard as Ie}from"./PumpCard-CRoAqE-P.js";import{CustomerDetails as Ae}from"./CustomerDetails-B_HWCKu1.js";import{PrinterStatus as _e}from"./PrinterStatus-DcUuoLTn.js";import{GetCashier as Fe}from"./GetCashier-DCamq4FL.js";import{GetDateTime as Ee}from"./GetDateTime-MRAYoWoF.js";import{ThemeSwitcher as Te}from"./ThemeSwitcher-C9_r_ET5.js";import Me from"./Index-XwismYo5.js";import{CardDetails as Re}from"./CardDetails-BuRGdfyB.js";import{S as ke,t as ze,a as N}from"./SaleWindowTabs-z_BEwvU0.js";import Be from"./ReportsIndex-C2hQj1Fr.js";import{c as b}from"./chunk-H4VOEXHF-37N_hzUr.js";import{c as Je}from"./chunk-J333S7JQ-eJp6Yx9o.js";import{c as Le}from"./chunk-5ALFRFZW-Yvy2yA3w.js";import{s as Ge}from"./chunk-IXXDDLGU-DXN0Qzp8.js";import{i as W}from"./chunk-GQQM5TNQ-CA0Ap-YZ.js";import"./iconBase-DTnZkvwB.js";import"./index-CZqxA_4O.js";import"./chunk-N2KXC5ZE-CE87_oYr.js";import"./chunk-XHQUSKIE-B_gLVVk5.js";import"./chunk-RJKRL3AU-CjtrMR1U.js";import"./useFocusable-CxK_f5uy.js";import"./index-Dqe4RBF5.js";import"./FocusScope-BcBajasC.js";import"./useControlledState-CJ9inb8E.js";import"./index-BYLHRmAd.js";import"./chunk-44JHHBS2-HWSdsSTK.js";import"./useLabel-6FXJduou.js";import"./useLabels-D2l6J5hh.js";import"./useListState-BBrNH8EO.js";import"./chunk-RQNQ5XFG-BKWh2CkW.js";import"./index-MIy9tjN7.js";import"./chunk-P2T5LMDM-Cc6S_plV.js";import"./VisuallyHidden-teXUSnkL.js";import"./chunk-6NL67ZRH-C1nJOAQm.js";import"./chunk-DBLREEYE-C_6eLj7R.js";import"./chunk-2PIR7DFM-CbcDDgM_.js";import"./PumpDelivery-Cz7IHNr1.js";import"./chunk-YRZGWF2W-FrCUaW-l.js";import"./useToggleState-CEyehh4n.js";import"./useFormReset-B7tW5NYw.js";import"./chunk-CAFRINWI-BTDo8zfp.js";import"./useFormValidationState-BRnJGrY2.js";import"./Icon-CwTRvUPZ.js";import"./PumpStatus-5SYFXcQO.js";import"./index-DiMxSgGp.js";import"./chunk-4WFLSIHH-Dkf8CXke.js";import"./index-OX6F5BsD.js";import"./chunk-M3MASYO7-COuMGrJ1.js";import"./chunk-JHUBASYZ-BAEUdGwW.js";import"./ElectricJournal-CBMMBMHO.js";import"./index-X92CTFGl.js";import"./AboutSoftware-Bg5MCso5.js";import"./ApplicationLogo-B7sZYleW.js";import"./chunk-NK4BRF7C-Bu-j2Buj.js";function qt(){const[K,Ue]=r.useState([]),[v,c]=r.useState(""),[C,Q]=r.useState([]),[X,q]=r.useState([]),[Z,p]=r.useState(!1),[f,h]=r.useState(()=>{const e=localStorage.getItem("deliveryData");return e?JSON.parse(e):[]}),[d,D]=r.useState(null),[w,I]=r.useState(!1),[A,ee]=r.useState(!1),u=r.useRef(null),[_,Ve]=r.useState([]),[F,j]=r.useState(0),[te,ae]=r.useState(!1),[$e,se]=r.useState(0),[oe,E]=r.useState(!1),[T,M]=r.useState(""),[R,k]=r.useState(""),[z,B]=r.useState(""),[J,L]=r.useState(""),[x,G]=r.useState(""),[S,U]=r.useState(""),[y,V]=r.useState("");r.useState(""),r.useState(null);const re=async()=>{if((await ve.fire({title:"Are you sure?",text:"You are about to log out and you won't be able to recover this session!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, log out!"})).isConfirmed)try{await m.post("/logout"),window.location.href="/"}catch(a){console.error("Error logging out:",a)}},ne=()=>{E(!0)},$=()=>{E(!1)},le=()=>{$()},ie=e=>{h(a=>{const i=[...a,e];return localStorage.setItem("deliveryData",JSON.stringify(i)),i})},ce=()=>{c("")},de=()=>{c(`Subtotal: ₱${g}`)},me=()=>{if(f.length===0){n.error("No transactions to void");return}h([]),localStorage.removeItem("transaction"),localStorage.removeItem("deliveryData"),localStorage.removeItem("disabledIds"),n.success("All transactions voided."),j(0),c(""),window.dispatchEvent(new Event("disabledIdsUpdated"))},ue=()=>{if(console.log("Selected Row:",d),d!==null){const e=f.filter(o=>o.Delivery_ID!==d);h(e),localStorage.setItem("deliveryData",JSON.stringify(e)),n.success("Transaction voided"),D(null);const a=e.reduce((o,l)=>o+parseFloat(l.Amount||0),0).toFixed(2),i=Math.max(0,F-a).toFixed(2);j(F),c(i);const s=localStorage.getItem("disabledIds");if(s){const o=new Set(JSON.parse(s));o.delete(d),localStorage.setItem("disabledIds",JSON.stringify(Array.from(o))),window.dispatchEvent(new Event("disabledIdsUpdated"))}}else n.error("No transaction selected")},H=()=>{ee(!0),window.removeEventListener("click",H)};r.useEffect(()=>{window.addEventListener("click",H);const e=()=>{m.get("/get-pump-status").then(s=>{const o=s.data;Q(o);const l=o.some(O=>O.Data.NozzleUp);A&&(l&&!w?(u.current&&(u.current.loop=!0,u.current.play().catch(O=>{console.error("Error playing sound:",O)})),I(!0)):!l&&w&&(u.current&&(u.current.pause(),u.current.currentTime=0),I(!1)))}).catch(s=>{console.error("Error fetching pump status:",s)})},a=()=>{m.get("/get-mop").then(s=>{q(s.data.data);const o=K.some(l=>l.MOP_Ref==="3");p(o)}).catch(s=>{console.error("Error fetching MOP list:",s)})};e(),a();const i=setInterval(e,500);return()=>clearInterval(i)},[w,A]);const pe=e=>{c(a=>a+e),j(a=>a+e)},fe=async()=>{try{const e=await m.post("/stop-all-pumps");n.success("All pumps stopped successfully"),console.log("All pumps stopped:",e.data)}catch(e){n.error("Error stopping all pumps"),console.error("Error stopping all pumps:",e)}},ge=async()=>{try{const e={Type:"FullTank"},a=await m.post("/authorize-all-pumps",e);n.success("All pumps authorized successfully"),console.log("All pumps authorized:",a.data)}catch(e){n.error("Error authorizing all pumps"),console.error("Error authorizing all pumps:",e)}},Y=async e=>{if(!e){n.error("Transaction ID is undefined");return}try{const i=(await m.get(`/print-receipt/${e}`)).data}catch(a){n.error("Error fetching receipt data"),console.error("Error fetching receipt data:",a)}},he={handleLogout:re,handleVoid:ue,handleVoidAll:me,setInputValue:c,handleClear:ce,handleSubTotal:de,handlePrintReceipt:Y,handleStopAllPumps:fe,handleAuthorizeAllPumps:ge,handleOpenCustomerDetails:ne,handleOpenDrawer:async()=>{try{const e=await m.get("/open-cash-drawer");n.success("Drawer opened successfully"),console.log("Drawer opened:",e.data)}catch(e){n.error("Error opening drawer"),console.error("Error opening drawer:",e.response?e.response.data:e.message)}}},xe=async e=>{console.log("MOP selected:",e);const a=parseFloat(v.replace("₱","").replace(",",""));if(v===""||a<=0){n.error("Please enter an amount before selecting a method of payment.");return}const i=JSON.parse(localStorage.getItem("transaction"))||{subtotal:parseFloat(g),payments:[],remainingBalance:parseFloat(g)},s=i.remainingBalance-a;if(s>=0)i.payments.push({mopName:e.MOP_Name,amount:a}),i.remainingBalance=s,localStorage.setItem("transaction",JSON.stringify(i)),e.MOP_Ref==="3"?p(!0):s===0?await P():c(`Amount Due: ₱${s.toFixed(2)}`);else{const o=Math.abs(s).toFixed(2);n.success(`Change: ₱${o}`),i.payments.push({mopName:e.MOP_Name,amount:a}),i.remainingBalance=0,localStorage.setItem("transaction",JSON.stringify(i)),c(`Change: ₱${o}`),c(`Change: ₱${o}`),e.MOP_Ref==="3"?p(!0):await P()}},g=f.reduce((e,a)=>e+parseFloat(a.Amount||0),0).toFixed(2),[Se,ye]=r.useState({change:0,mopNames:[],mopPayments:[]}),Ne=(e,a)=>{if(d==null){n.error("Please select an item to apply discount");return}e.discount_id>=1&&e.discount_id<=4&&n.info("Discount not applicable"),console.log("Selected Row:",d),console.log("Selected Discount:",e),console.log("Selected Preset:",a);const i=f.map(s=>{if(s.Delivery_ID===d){let o=0;switch(console.log("Selected Discount Type:",e==null?void 0:e.discount_type),console.log("Preset Value:",a==null?void 0:a.preset_value),e==null?void 0:e.discount_type){case"1":o=parseFloat(s.Amount)*parseFloat(a==null?void 0:a.preset_value)/100;break;case"2":o=parseFloat(s.Volume)*parseFloat(a==null?void 0:a.preset_value);break;case"3":o=parseFloat(a==null?void 0:a.preset_value);break}console.log("Calculated Discount Amount:",o);const l=parseFloat(s.Amount)-o;return{...s,Amount:l.toFixed(2),DiscountedAmount:o.toFixed(2),PresetName:a==null?void 0:a.preset_name}}return s});h(i),n.success("Discount applied.")},P=async()=>{const e=JSON.parse(localStorage.getItem("transaction"));if(!e){n.error("No transaction data found");return}if(_&&_.MOP_Ref==="3"&&(!x||!S||!y)){n.error("Please provide complete card details."),p(!0);return}const a=e.payments.reduce((s,o)=>s+o.amount,0),i=Math.max(0,a-e.subtotal).toFixed(2);try{const o=(await m.post("/store-transactions",{subtotal:e.subtotal,taxTotal:e.subtotal/1.12*.12,change:parseFloat(i),mopNames:e.payments.map(l=>l.mopName.trim()),mopPayments:e.payments,deliveryIds:f.map(l=>({Delivery_ID:l.Delivery_ID,Pump:l.Pump,Nozzle:l.Nozzle,Volume:l.Volume,Price:l.Price,Amount:l.Amount,DiscountedAmount:l.DiscountedAmount,PresetName:l.PresetName,FuelGradeName:l.FuelGradeName})),customer:{name:T,address:R,tin:z,businessStyle:J},cardDetails:{name:y,code:S,number:x}})).data.transaction;o?(localStorage.setItem("transactionId",o),n.success("Transaction saved successfully"),ae(!0),se(0),c("Transaction Complete"),ye({change:parseFloat(i),mopNames:e.payments.map(l=>l.mopName),mopPayments:e.payments}),localStorage.removeItem("transaction"),G(""),U(""),V(""),Y(o)):n.error("Error retrieving transaction ID")}catch(s){n.error("Error saving transaction"),console.error("Error saving transaction:",s)}};return t.jsxs(t.Fragment,{children:[t.jsx(be,{title:"Home"}),t.jsx("audio",{ref:u,src:"assets/audio/nozzle-status-sound.wav"}),t.jsxs("main",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 p-2 h-[100vh]",children:[t.jsxs(b,{className:"dark:bg-gray-900 p-2",children:[t.jsx("div",{className:"flex-none",children:t.jsxs(b,{className:"max-w-full h-full",children:[t.jsxs(Je,{className:"justify-between",children:[t.jsx(Fe,{}),t.jsx(Ee,{})]}),t.jsx(Le,{className:"justify-between",children:t.jsxs("div",{className:"flex gap-4",children:[t.jsx("div",{className:"w-[70%] h-[70px] bg-slate-200 rounded-lg shadow-sm relative",children:t.jsx(we,{position:"top-right",autoClose:2e3,hideProgressBar:!1,newestOnTop:!1,closeOnClick:!0,rtl:!1,pauseOnFocusLoss:!0,draggable:!0,pauseOnHover:!1,theme:"light",transition:je,style:{position:"absolute",top:0,right:0,bottom:0,left:0,width:"100%",height:"50%"}})}),t.jsx(_e,{}),t.jsx(Te,{})]})})]})}),t.jsx(Ge,{y:3}),t.jsx("div",{className:"flex-grow",children:t.jsx(ke,{deliveryData:f,setSelectedRow:D,subtotal:g,transactionSaved:te,transactionSummary:Se})}),t.jsx("div",{className:"flex-none",children:t.jsxs(b,{className:"w-full gap-2 p-2",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx(W,{variant:"bordered",label:t.jsx("p",{className:"font-bold text-xl",children:"SUBTOTAL"}),size:"lg",value:`₱${g}`,labelPlacement:"outside-left",className:"w-[40%]",classNames:{input:["text-black text-xl font-bold text-right"]},isReadOnly:!0}),t.jsx(W,{variant:"bordered",className:"w-[60%]",classNames:{input:["text-black text-2xl font-bold text-right"]},value:v,isReadOnly:!0,size:"lg"})]}),t.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-1",children:t.jsx(Ce,{handleButtonClick:pe,buttons:De,buttonClickHandlers:he,setInputValue:c})})]})})]}),t.jsx(b,{className:"dark:bg-gray-900 p-2",children:t.jsx("div",{className:"flex w-full flex-col",children:t.jsxs(ze,{"aria-label":"Pumps",fullWidth:!0,children:[t.jsx(N,{title:t.jsx("p",{className:"font-extrabold",children:"PUMPS"}),children:t.jsx(r.Suspense,{fallback:t.jsx("div",{children:"Loading..."}),children:C.length===0?t.jsxs("div",{className:"col-span-4 flex flex-col items-center justify-center py-12 text-xl font-extrabold text-center text-red-500",children:[t.jsx(Pe,{className:"text-7xl"}),t.jsx("p",{children:"No pumps connected!"})]}):t.jsx("div",{className:"overflow-y-auto scrollbar-hide max-h-screen p-1",children:t.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2",children:C.map(e=>t.jsx(Ie,{pump:e,handleAppendDeliveryData:ie},e.Id))})})})},"pumps"),t.jsx(N,{title:t.jsx("p",{className:"font-extrabold",children:"MOP"}),children:t.jsx(Oe,{mopList:X,onSelectMOP:xe,onApplyDiscount:Ne})},"mop"),t.jsx(N,{title:t.jsx("p",{className:"font-extrabold",children:"REPORTS"}),children:t.jsx(Be,{})},"reports"),t.jsx(N,{title:t.jsx("p",{className:"font-extrabold",children:"CONFIG"}),children:t.jsx(Me,{})},"config")]})})})]}),t.jsx(Ae,{isOpen:oe,onClose:$,onCustomerDataChange:(e,a)=>{switch(e){case"name":M(a);break;case"address":k(a);break;case"tin":B(a);break;case"businessStyle":L(a);break}},customerName:T,customerAddress:R,customerTIN:z,customerBusinessStyle:J,onSave:le,setCustomerName:M,setCustomerAddress:k,setCustomerTIN:B,setCustomerBusinessStyle:L}),t.jsx(Re,{isOpen:Z,onOpenChange:p,cardNumber:x,setCardNumber:G,approvalCode:S,setApprovalCode:U,cardHolderName:y,setCardHolderName:V,onSave:async()=>{if(!x||!S||!y){n.error("Please fill in all card details.");return}p(!1),await P()}})]})}export{qt as default};
