import{r as l,j as a,Y as be,a as u}from"./app-BgclCP_U.js";import{S as we}from"./sweetalert2.all-uG3e2lQU.js";import{Q as je,X as Pe,G as Oe,B as r}from"./index-DUmXHUp-.js";import De from"./MOPCard-CvGEiQ21.js";import Ce,{buttons as Ie}from"./POSKeyboard-C6lBy9vE.js";import{PumpCard as Ae}from"./PumpCard-CuPwe8sz.js";import{CustomerDetails as _e}from"./CustomerDetails-Cewu7i4M.js";import{PrinterStatus as Te}from"./PrinterStatus-CYjSKcHk.js";import{GetCashier as Fe}from"./GetCashier-C710YvMF.js";import{GetDateTime as Ee}from"./GetDateTime-3h-JBR3J.js";import{ThemeSwitcher as Me}from"./ThemeSwitcher-DkwrZNqe.js";import Re from"./Index-CWwKe_ix.js";import{CardDetails as ke}from"./CardDetails-Bw3p3mkq.js";import ze from"./SaleWindowTabs-DJSwARTF.js";import Be from"./ReportsIndex-BMOMziml.js";import{c as v}from"./chunk-H4VOEXHF-TewfOLb0.js";import{c as Ve}from"./chunk-J333S7JQ-fhG3Ko0V.js";import{c as Je}from"./chunk-5ALFRFZW-DZJt4FN_.js";import{s as Le}from"./chunk-IXXDDLGU-B3bMcQ9V.js";import{i as X}from"./chunk-GQQM5TNQ-CwUyVOv_.js";import{t as Ge,a as N}from"./chunk-FXLYF44B-HLJFA5T_.js";import"./iconBase-D3lqyo71.js";import"./index-Bpea34S8.js";import"./chunk-N2KXC5ZE-OZCedwgk.js";import"./chunk-XHQUSKIE-C9evg4Jy.js";import"./chunk-RJKRL3AU-CjtrMR1U.js";import"./useFocusable-CtZfeggp.js";import"./SelectionManager-fmqYxgu0.js";import"./FocusScope-DU-SyPrP.js";import"./scrollIntoView-SfQOsQd-.js";import"./useControlledState-DEEM-shP.js";import"./chunk-44JHHBS2-C3-jQeuQ.js";import"./useLabel-DpShN-Pb.js";import"./useLabels-Cb_neJ1j.js";import"./useCollator-BBcv62qp.js";import"./useListState-COLDqLzF.js";import"./chunk-RQNQ5XFG-CmL0HLIT.js";import"./index-Dnai1UOS.js";import"./index-DpSBb8zT.js";import"./index-D3TozaOH.js";import"./chunk-P2T5LMDM-reKcKOSN.js";import"./getScrollParent-ClU_Bz4K.js";import"./VisuallyHidden-DfowBU03.js";import"./chunk-6NL67ZRH-DYxa27IY.js";import"./chunk-DBLREEYE-CG8yp442.js";import"./chunk-2PIR7DFM-CbcDDgM_.js";import"./PumpDelivery-C91bALmS.js";import"./chunk-YRZGWF2W-Bu1rOQLJ.js";import"./chunk-KBN3H6OQ-DOSo4uLf.js";import"./useToggleState-DB5UMKni.js";import"./useFormReset-DYDVEd1s.js";import"./chunk-CAFRINWI-BTDo8zfp.js";import"./useFormValidationState-Ct6XxOLM.js";import"./LiveAnnouncer-D-UZuySi.js";import"./useHasTabbableChild-CXsmZ4V0.js";import"./Icon-CpFG_daB.js";import"./PumpStatus-5SYFXcQO.js";import"./chunk-4WFLSIHH-C4LdqOkj.js";import"./index-CWVs8GWl.js";import"./chunk-M3MASYO7-Bt50UMbM.js";import"./chunk-JHUBASYZ-DnA3zP3Q.js";import"./ElectricJournal-DEuL0LDd.js";import"./index-BB6kETrK.js";import"./index-X92CTFGl.js";import"./AboutSoftware-BkquhDUy.js";import"./ApplicationLogo-CjFftTJE.js";import"./chunk-NK4BRF7C-DzQw0L6L.js";import"./PriceChange-B1EUtkJ2.js";import"./chunk-RUXXUVWM-DVz6Pog_.js";function ca(){const[q,Ue]=l.useState([]),[b,c]=l.useState(""),[D,Z]=l.useState([]),[ee,te]=l.useState([]),[ae,f]=l.useState(!1),[m,h]=l.useState(()=>{const e=localStorage.getItem("deliveryData");return e?JSON.parse(e):[]}),[d,C]=l.useState(null),[w,I]=l.useState(!1),[A,oe]=l.useState(!1),p=l.useRef(null),[_,$e]=l.useState([]),[T,j]=l.useState(0),[se,F]=l.useState(!1),[He,re]=l.useState(0),[ne,E]=l.useState(!1),[M,R]=l.useState(""),[k,z]=l.useState(""),[B,V]=l.useState(""),[J,L]=l.useState(""),[x,G]=l.useState(""),[S,U]=l.useState(""),[y,$]=l.useState(""),le=async()=>{if((await we.fire({title:"Are you sure?",text:"You are about to log out and you won't be able to recover this session!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, log out!"})).isConfirmed)try{await u.post("/logout"),window.location.href="/"}catch(t){console.error("Error logging out:",t)}},ie=()=>{E(!0)},H=()=>{E(!1)},ce=()=>{H()},me=e=>{h(t=>{const i=[...t,e];return localStorage.setItem("deliveryData",JSON.stringify(i)),i})},de=()=>{c("")},Y=(e,t)=>{t==="success"?r.success(e):t==="error"&&r.error(e)},ue=()=>{c(`Subtotal: ₱${g}`)},pe=()=>{if(m.length===0){r.error("No items to void");return}h([]),setTimeout(()=>{console.log("DeliveryData after reset:",m)},0),localStorage.removeItem("transaction"),localStorage.removeItem("deliveryData"),localStorage.removeItem("disabledIds"),r.success("All items voided"),F(!1),Q({mopPayments:[],change:0}),j(0),c(""),window.dispatchEvent(new Event("disabledIdsUpdated"))},fe=()=>{if(console.log("Selected Row:",d),d!==null){const e=m.filter(s=>s.Delivery_ID!==d);h(e),localStorage.setItem("deliveryData",JSON.stringify(e)),r.success("Item voided"),C(null);const t=e.reduce((s,n)=>s+parseFloat(n.Amount||0),0).toFixed(2),i=Math.max(0,T-t).toFixed(2);j(T),c(i);const o=localStorage.getItem("disabledIds");if(o){const s=new Set(JSON.parse(o));s.delete(d),localStorage.setItem("disabledIds",JSON.stringify(Array.from(s))),window.dispatchEvent(new Event("disabledIdsUpdated"))}}else r.error("No item to void")},W=()=>{oe(!0),window.removeEventListener("click",W)};l.useEffect(()=>{window.addEventListener("click",W);const e=()=>{u.get("/get-pump-status").then(o=>{const s=o.data;Z(s);const n=s.some(O=>O.Data.NozzleUp);A&&(n&&!w?(p.current&&(p.current.loop=!0,p.current.play().catch(O=>{console.error("Error playing sound:",O)})),I(!0)):!n&&w&&(p.current&&(p.current.pause(),p.current.currentTime=0),I(!1)))}).catch(o=>{console.error("Error fetching pump status:",o)})},t=()=>{u.get("/get-mop").then(o=>{te(o.data.data);const s=q.some(n=>n.MOP_Ref==="3");f(s)}).catch(o=>{console.error("Error fetching MOP list:",o)})};e(),t();const i=setInterval(e,500);return()=>clearInterval(i)},[w,A]);const ge=e=>{c(t=>t+e),j(t=>t+e)},he=async()=>{try{const e=await u.post("/stop-all-pumps");r.success("All pumps stopped"),console.log("All pumps stopped:",e.data)}catch(e){r.error("Error stopping all pumps"),console.error("Error stopping all pumps:",e)}},xe=async()=>{try{const e={Type:"FullTank"},t=await u.post("/authorize-all-pumps",e);r.success("All pumps authorized"),console.log("All pumps authorized:",t.data)}catch(e){r.error("Error authorizing all pumps"),console.error("Error authorizing all pumps:",e)}},K=async e=>{if(!e){r.error("Transaction ID is undefined");return}try{const i=(await u.get(`/print-receipt/${e}`)).data}catch(t){r.error("Error fetching receipt data"),console.error("Error fetching receipt data:",t)}},Se={handleLogout:le,handleVoid:fe,handleVoidAll:pe,setInputValue:c,handleClear:de,handleSubTotal:ue,handlePrintReceipt:K,handleStopAllPumps:he,handleAuthorizeAllPumps:xe,handleOpenCustomerDetails:ie,handleOpenDrawer:async()=>{try{const e=await u.get("/open-cash-drawer");r.success("Drawer opened"),console.log("Drawer opened:",e.data)}catch(e){r.error("Error opening drawer"),console.error("Error opening drawer:",e.response?e.response.data:e.message)}}},ye=async e=>{console.log("MOP selected:",e);const t=parseFloat(b.replace("₱","").replace(",",""));if(b===""||t<=0){r.warning("Please enter an amount first.");return}const i=JSON.parse(localStorage.getItem("transaction"))||{subtotal:parseFloat(g),payments:[],remainingBalance:parseFloat(g)},o=i.remainingBalance-t;if(o>=0)i.payments.push({mopName:e.MOP_Name,amount:t}),i.remainingBalance=o,localStorage.setItem("transaction",JSON.stringify(i)),e.MOP_Ref==="3"?f(!0):o===0?await P():c(`Amount Due: ₱${o.toFixed(2)}`);else{const s=Math.abs(o).toFixed(2);r.success(`Change: ₱${s}`),i.payments.push({mopName:e.MOP_Name,amount:t}),i.remainingBalance=0,localStorage.setItem("transaction",JSON.stringify(i)),c(`Change: ₱${s}`),c(`Change: ₱${s}`),e.MOP_Ref==="3"?f(!0):await P()}},g=m.reduce((e,t)=>e+parseFloat(t.Amount||0),0).toFixed(2),[ve,Q]=l.useState({change:0,mopNames:[],mopPayments:[],deliveryData:[]}),Ne=(e,t)=>{if(d==null){r.error("Please select an item to apply discount");return}if(e.discount_id>=1&&e.discount_id<=4){r.info("Discount not applicable");return}console.log("Selected Row:",d),console.log("Selected Discount:",e),console.log("Selected Preset:",t);const i=m.map(o=>{if(o.Delivery_ID===d){if(o.DiscountedAmount)return r.info("Discount already applied to this item."),o;let s=0;switch(console.log("Selected Discount Type:",e==null?void 0:e.discount_type),console.log("Preset Value:",t==null?void 0:t.preset_value),e==null?void 0:e.discount_type){case"1":s=parseFloat(o.Amount)*parseFloat(t==null?void 0:t.preset_value)/100;break;case"2":s=parseFloat(o.Volume)*parseFloat(t==null?void 0:t.preset_value);break;case"3":s=parseFloat(t==null?void 0:t.preset_value);break}console.log("Calculated Discount Amount:",s);const n=parseFloat(o.Amount)-s;return{...o,OriginalAmount:o.Amount,Amount:n.toFixed(2),DiscountedAmount:s.toFixed(2),PresetName:t==null?void 0:t.preset_name,DiscountType:e==null?void 0:e.discount_type,PresetValue:t==null?void 0:t.preset_value}}return o});h(i),r.success("Discount applied.")},P=async()=>{const e=JSON.parse(localStorage.getItem("transaction"));if(!e){r.error("No transaction found");return}if(_&&_.MOP_Ref==="3"&&(!x||!S||!y)){r.error("Please provide complete card details."),f(!0);return}const t=e.payments.reduce((o,s)=>o+s.amount,0),i=Math.max(0,t-e.subtotal).toFixed(2);try{const s=(await u.post("/store-transactions",{subtotal:e.subtotal,taxTotal:e.subtotal/1.12*.12,change:parseFloat(i),mopNames:e.payments.map(n=>n.mopName.trim()),mopPayments:e.payments,deliveryIds:m.map(n=>({Delivery_ID:n.Delivery_ID,Pump:n.Pump,Nozzle:n.Nozzle,Volume:n.Volume,Price:n.Price,Amount:n.Amount,OriginalAmount:n.OriginalAmount,DiscountedAmount:n.DiscountedAmount,DiscountType:n.DiscountType,PresetName:n.PresetName,PresetValue:n.PresetValue,FuelGradeName:n.FuelGradeName})),customer:{name:M,address:k,tin:B,businessStyle:J},cardDetails:{name:y,code:S,number:x}})).data.transaction;s?(localStorage.setItem("transactionId",s),r.success("Transaction saved"),F(!0),re(0),c("Transaction Complete"),Q({change:parseFloat(i),mopNames:e.payments.map(n=>n.mopName),mopPayments:e.payments,deliveryData:m}),localStorage.removeItem("transaction"),G(""),U(""),$(""),K(s)):r.error("Error retrieving transaction ID")}catch(o){r.error("Error saving transaction"),console.error("Error saving transaction:",o)}};return a.jsxs(a.Fragment,{children:[a.jsx(be,{title:"Home"}),a.jsx("audio",{ref:p,src:"assets/audio/nozzle-status-sound.wav"}),a.jsxs("main",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 p-2 h-[100vh]",children:[a.jsxs(v,{className:"dark:bg-gray-900 p-2",children:[a.jsx("div",{className:"flex-none",children:a.jsxs(v,{className:"max-w-full h-full",children:[a.jsxs(Ve,{className:"justify-between",children:[a.jsx(Fe,{}),a.jsx(Ee,{})]}),a.jsx(Je,{className:"justify-between",children:a.jsxs("div",{className:"flex gap-4",children:[a.jsx("div",{className:"w-[70%] h-[70px] bg-slate-200 rounded-lg shadow-sm relative",children:a.jsx(je,{position:"top-right",autoClose:2e3,hideProgressBar:!1,newestOnTop:!1,closeOnClick:!0,rtl:!1,pauseOnFocusLoss:!0,draggable:!0,pauseOnHover:!1,theme:"light",transition:Pe,style:{position:"absolute",top:0,right:0,bottom:0,left:0,width:"100%",height:"50%"}})}),a.jsx(Te,{}),a.jsx(Me,{})]})})]})}),a.jsx(Le,{y:3}),a.jsx("div",{className:"flex-grow",children:a.jsx(ze,{deliveryData:m,setSelectedRow:C,subtotal:g,transactionSaved:se,transactionSummary:ve})}),a.jsx("div",{className:"flex-none",children:a.jsxs(v,{className:"w-full gap-2 p-2",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsx(X,{variant:"bordered",label:a.jsx("p",{className:"font-bold text-xl",children:"SUBTOTAL"}),size:"lg",value:`₱${g}`,labelPlacement:"outside-left",className:"w-[40%]",classNames:{input:["text-black text-xl font-bold text-right"]},isReadOnly:!0}),a.jsx(X,{variant:"bordered",className:"w-[60%]",classNames:{input:["text-black text-2xl font-bold text-right"]},value:b,isReadOnly:!0,size:"lg"})]}),a.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-1",children:a.jsx(Ce,{handleButtonClick:ge,buttons:Ie,buttonClickHandlers:Se,setInputValue:c})})]})})]}),a.jsx(v,{className:"dark:bg-gray-900 p-2",children:a.jsx("div",{className:"flex w-full flex-col",children:a.jsxs(Ge,{"aria-label":"Pumps",fullWidth:!0,children:[a.jsx(N,{title:a.jsx("p",{className:"font-extrabold",children:"PUMPS"}),children:a.jsx(l.Suspense,{fallback:a.jsx("div",{children:"Loading..."}),children:D.length===0?a.jsxs("div",{className:"col-span-4 flex flex-col items-center justify-center py-12 text-xl font-extrabold text-center text-red-500",children:[a.jsx(Oe,{className:"text-7xl"}),a.jsx("p",{children:"No pumps connected!"})]}):a.jsx("div",{className:"overflow-y-auto scrollbar-hide max-h-screen p-1",children:a.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2",children:D.map(e=>a.jsx(Ae,{pump:e,handleAppendDeliveryData:me,onToast:Y},e.Id))})})})},"pumps"),a.jsx(N,{title:a.jsx("p",{className:"font-extrabold",children:"MOP"}),children:a.jsx(De,{mopList:ee,onSelectMOP:ye,onApplyDiscount:Ne})},"mop"),a.jsx(N,{title:a.jsx("p",{className:"font-extrabold",children:"REPORTS"}),children:a.jsx(Be,{})},"reports"),a.jsx(N,{title:a.jsx("p",{className:"font-extrabold",children:"CONFIG"}),children:a.jsx(Re,{onToast:Y})},"config")]})})})]}),a.jsx(_e,{isOpen:ne,onClose:H,onCustomerDataChange:(e,t)=>{switch(e){case"name":R(t);break;case"address":z(t);break;case"tin":V(t);break;case"businessStyle":L(t);break}},customerName:M,customerAddress:k,customerTIN:B,customerBusinessStyle:J,onSave:ce,setCustomerName:R,setCustomerAddress:z,setCustomerTIN:V,setCustomerBusinessStyle:L}),a.jsx(ke,{isOpen:ae,onOpenChange:f,cardNumber:x,setCardNumber:G,approvalCode:S,setApprovalCode:U,cardHolderName:y,setCardHolderName:$,onSave:async()=>{if(!x||!S||!y){r.error("Please fill in all card details.");return}f(!1),await P()}})]})}export{ca as default};
