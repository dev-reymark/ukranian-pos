import{r,j as t,Y,a as u}from"./app-B8votc-R.js";import{F as q}from"./PumpDelivery-CI1sXPBF.js";import{I as Q,_ as o}from"./index-apfAsbfS.js";import{S as X,t as Z,a as _}from"./SaleWindowTabs-CQC8-L5F.js";import ee from"./MOPCard-CaDJ8iq4.js";import te,{buttons as se}from"./POSKeyboard-Cztlv_jz.js";import ae from"./PumpCard-C9U80pHP.js";import{c as w}from"./chunk-H4VOEXHF-DMvmDHFx.js";import{i as re}from"./chunk-GQQM5TNQ-CKOFxFBX.js";import"./chunk-2PIR7DFM-CbcDDgM_.js";import"./chunk-N2KXC5ZE-C4pUKzdp.js";import"./chunk-YRZGWF2W-DC1O9SOb.js";import"./useHover-C_8tjCSG.js";import"./chunk-XHQUSKIE-B5JL3-hA.js";import"./index-Cduk1bFc.js";import"./index-DkCRmnkc.js";import"./useControlledState-Mq4YlRrW.js";import"./chunk-IXXDDLGU-BWSSiAKR.js";import"./chunk-DBLREEYE-B2u3oIUP.js";import"./index-CYa-8VNu.js";import"./chunk-6NL67ZRH-BqCJzn5J.js";import"./useLabels-R1SqVGtu.js";import"./Icon-_8hBHZyD.js";import"./PumpStatus-5SYFXcQO.js";import"./index-BDJsrkvs.js";import"./chunk-P2T5LMDM-BhCdCRn_.js";function Ae(){const[m,l]=r.useState(""),[N,F]=r.useState([]),[M,A]=r.useState([]),[c,v]=r.useState(()=>{const e=localStorage.getItem("deliveryData");return e?JSON.parse(e):[]}),[f,j]=r.useState(null),[S,I]=r.useState(!1),[b,z]=r.useState(!1),d=r.useRef(null),[P,D]=r.useState([]),[g,h]=r.useState(0),[oe,T]=r.useState(!1),[ne,R]=r.useState(0),C=e=>{v(a=>{const s=[...a,e];return localStorage.setItem("deliveryData",JSON.stringify(s)),s})};r.useEffect(()=>{const e=c.reduce((a,s)=>a+parseFloat(s.Amount||0),0).toFixed(2);l(`Subtotal: ₱${e}`)},[c]);const U=()=>{l("")},V=()=>{l(`Subtotal: ₱${p}`)},k=()=>{if(c.length===0){o.error("No transactions to void");return}v([]),localStorage.removeItem("deliveryData"),localStorage.removeItem("disabledIds"),o.success("All transactions voided."),h(0),window.dispatchEvent(new Event("disabledIdsUpdated"))},J=()=>{if(console.log("Selected Row:",f),f!==null){const e=c.filter(i=>i.Delivery_ID!==f);v(e),localStorage.setItem("deliveryData",JSON.stringify(e)),o.success("Transaction voided"),j(null);const a=e.reduce((i,x)=>i+parseFloat(x.Amount||0),0).toFixed(2),s=Math.max(0,g-a).toFixed(2);h(g),l(s);const n=localStorage.getItem("disabledIds");if(n){const i=new Set(JSON.parse(n));i.delete(f),localStorage.setItem("disabledIds",JSON.stringify(Array.from(i))),window.dispatchEvent(new Event("disabledIdsUpdated"))}}else o.error("No transaction selected")},E=()=>{z(!0),window.removeEventListener("click",E)};r.useEffect(()=>{window.addEventListener("click",E);const e=()=>{u.get("/get-pump-status").then(n=>{const i=n.data;F(i);const x=i.some(y=>y.Data.NozzleUp);b&&(x&&!S?(d.current&&(d.current.loop=!0,d.current.play().catch(y=>{console.error("Error playing sound:",y)})),I(!0)):!x&&S&&(d.current&&(d.current.pause(),d.current.currentTime=0),I(!1)))}).catch(n=>{console.error("Error fetching pump status:",n)})},a=()=>{u.get("/get-mop").then(n=>{A(n.data.data)}).catch(n=>{console.error("Error fetching MOP list:",n)})};e(),a();const s=setInterval(e,500);return()=>clearInterval(s)},[S,b]);const L=e=>{l(a=>a+e),h(a=>a+e)},$=async()=>{try{const e=await u.post("/stop-all-pumps");o.success("All pumps stopped successfully"),console.log("All pumps stopped:",e.data)}catch(e){o.error("Error stopping all pumps"),console.error("Error stopping all pumps:",e)}},O=async e=>{if(!e){o.error("Transaction ID is undefined");return}try{const s=(await u.get(`/print-receipt/${e}`)).data}catch(a){o.error("Error fetching receipt data"),console.error("Error fetching receipt data:",a)}},B={handleVoid:J,handleVoidAll:k,setInputValue:l,handleClear:U,handleSubTotal:V,handlePrintReceipt:O,handleStopAllPumps:$},G=async e=>{if(console.log("MOP selected:",e),m===""||parseFloat(m.replace("₱","").replace(",",""))<=0){o.error("Please enter an amount before selecting a method of payment.");return}D(e),await K()},p=c.reduce((e,a)=>e+parseFloat(a.Amount||0),0).toFixed(2),H=p/1.12*.12,W=g-p,K=async()=>{if(!P){o.error("Please select a method of payment");return}if(c.length===0){o.error("No transactions to save");return}try{const a=(await u.post("/store-transactions",{subtotal:p,taxTotal:H,change:W,mopName:P.MOP_Name.trim(),deliveryIds:c.map(s=>({Delivery_ID:s.Delivery_ID,Pump:s.Pump,Nozzle:s.Nozzle,Volume:s.Volume,Price:s.Price,Amount:s.Amount,FuelGradeName:s.FuelGradeName})),payment:m})).data.transaction;if(a){o.success("Transaction saved successfully"),T(!0);const s=p-g;R(s),s>0?l(`Amount Due: ₱${s.toFixed(2)}`):l(`Change: ₱${Math.abs(s).toFixed(2)}`),D(null),h(0),await O(a)}else o.error("Error retrieving transaction ID")}catch(e){o.error("Error saving transaction"),console.error("Error saving transaction:",e)}};return t.jsxs(t.Fragment,{children:[t.jsx(Y,{title:"Home"}),t.jsx("audio",{ref:d,src:"assets/audio/nozzle-status-sound.wav"}),t.jsx(Q,{position:"top-right"}),t.jsx("div",{className:"min-h-screen p-3",children:t.jsx("main",{className:"w-full h-full mx-auto",children:t.jsxs("div",{className:"grid gap-6 lg:grid-cols-2 lg:gap-4",children:[t.jsxs(w,{className:"flex flex-col h-full p-3",children:[t.jsx("div",{className:"flex-grow",children:t.jsx(X,{deliveryData:c,setSelectedRow:j,subtotal:p})}),t.jsxs(w,{className:"w-full gap-2 p-2",children:[t.jsx(re,{variant:"faded",classNames:{input:["text-black text-2xl font-bold text-right"]},value:m,isReadOnly:!0,size:"lg"}),t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-1",children:t.jsx(te,{handleButtonClick:L,buttons:se,buttonClickHandlers:B,setInputValue:l})})]})]}),t.jsx(w,{className:"flex items-start gap-4 rounded-lg bg-white p-6 shadow-[0px_14px_34px_0px_rgba(0,0,0,0.08)] ring-1 ring-white/[0.05] lg:pb-10",children:t.jsx("div",{className:"flex w-full flex-col",children:t.jsxs(Z,{"aria-label":"Options",fullWidth:!0,children:[t.jsx(_,{title:"PUMPS",children:N.length===0?t.jsxs("div",{className:"flex flex-col items-center mt-6",children:[t.jsx(q,{className:"w-12 h-12 text-danger"}),t.jsx("span",{className:"mt-4",children:"No pumps found"})]}):t.jsx("div",{className:"overflow-y-auto max-h-[calc(100vh-200px)] p-2",children:t.jsx("div",{className:"grid grid-cols-4 gap-2",children:N.map(e=>t.jsx(ae,{pump:e,handleAppendDeliveryData:C},e.Id))})})},"pumps"),t.jsx(_,{title:"MOP",children:t.jsx("div",{className:"grid grid-cols-4 gap-4",children:t.jsx(ee,{mopList:M,onSelectMOP:G})})},"mop")]})})})]})})})]})}export{Ae as default};
