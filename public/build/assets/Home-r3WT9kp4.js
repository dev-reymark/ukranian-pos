import{r as n,j as e,Y as te,c as g,a as ae,b as se,d as y}from"./app-DQR8ouMN.js";import{Q as re,X as oe,G as ne,B as i}from"./index-CPp1uo4P.js";import ie from"./MOPCard-DOjhAbFr.js";import{P as le,b as ce}from"./POSKeyboard-D5etx9Iw.js";import{PumpCard as me}from"./PumpCard-DnNNmKHv.js";import{CustomerDetails as ue}from"./CustomerDetails-DDSjWexm.js";import{PrinterStatus as de}from"./PrinterStatus-gRPiyC3u.js";import{GetCashier as pe}from"./GetCashier-COoSyuHp.js";import{GetDateTime as fe}from"./GetDateTime-BZCl_2r3.js";import{ThemeSwitcher as xe}from"./ThemeSwitcher-DuVTplr9.js";import he from"./Index-DmoCU88I.js";import{CardDetails as ge}from"./CardDetails-BDOTq989.js";import{SaleWindowTabs as ye}from"./SaleWindowTabs-_Sp3gY1w.js";import Se from"./ReportsIndex-BiGkjz0q.js";import{s as ve}from"./chunk-IXXDDLGU-BtRYqgzk.js";import{i as Ne}from"./chunk-GQQM5TNQ-BZdn_sLp.js";import{t as be,a as S}from"./chunk-FXLYF44B-Cdmm-oWP.js";import"./iconBase-ClxmNH_N.js";import"./index-BMtfhCBw.js";import"./SelectionManager-yDbbLw-S.js";import"./FocusScope-DMt3cHMA.js";import"./scrollIntoView-B1mZhU84.js";import"./useControlledState-DsOKAyM-.js";import"./chunk-44JHHBS2-BSFQFpH5.js";import"./useLabel-BpByWgep.js";import"./useLabels-CSRCNtbm.js";import"./useCollator-5Zmd5rxj.js";import"./useListState-DtcGX6Bb.js";import"./index-F91XIcke.js";import"./index-goXRPerO.js";import"./chunk-P2T5LMDM-MUOmPblZ.js";import"./getScrollParent-CSIo9Hxx.js";import"./VisuallyHidden-DiWMGts7.js";import"./chunk-DBLREEYE-CoXvdbmO.js";import"./chunk-2PIR7DFM-CbcDDgM_.js";import"./PumpDelivery-CZ3XJysT.js";import"./chunk-YRZGWF2W-Db8dcd_Q.js";import"./chunk-KBN3H6OQ-nz5roQ3_.js";import"./useToggleState-alzNwMpt.js";import"./useFormReset-DweNStx9.js";import"./chunk-CAFRINWI-BTDo8zfp.js";import"./useFormValidationState-BGLjVBHh.js";import"./LiveAnnouncer-C2oPZAHC.js";import"./useHasTabbableChild-BQh_kJOy.js";import"./Icon-CX6EwYYu.js";import"./PumpStatus-5SYFXcQO.js";import"./chunk-QXREVWCS-C8Ky7r9k.js";import"./chunk-4WFLSIHH-cEutGiMt.js";import"./chunk-M3MASYO7-DJpgnKTJ.js";import"./chunk-JHUBASYZ-sQ9hRzsO.js";import"./ElectricJournal-C7wKN--p.js";import"./index-BtHeAZYA.js";import"./index-DDrqCaiR.js";import"./index-X92CTFGl.js";import"./AboutSoftware-B9v8-ULu.js";import"./ApplicationLogo-HqxbR3WT.js";import"./PriceChange-et8VxGB4.js";import"./chunk-RUXXUVWM-CByahhe-.js";import"./NumberFormatter-DgUnyrzU.js";import"./chunk-6EHM2IL6-Cx_Mjnao.js";import"./index-4G2CWJVf.js";function Tt(){const[v,p]=n.useState(""),[O,B]=n.useState([]),[G,V]=n.useState([]),[u,N]=n.useState(()=>{const t=localStorage.getItem("deliveryData");return t?JSON.parse(t):[]}),[f,C]=n.useState(null),[b,w]=n.useState(!1),[_,H]=n.useState(!1),m=n.useRef(null),[I,je]=n.useState([]),[J,L]=n.useState(0),[U,F]=n.useState(!1),[Pe,$]=n.useState(0),[W,T]=n.useState(!1),[d,A]=n.useState({cardNumber:"",approvalCode:"",cardHolderName:""}),[q,x]=n.useState(!1),[c,M]=n.useState({name:"",address:"",tin:"",businessStyle:""}),R=()=>{T(!1)},K=()=>{R()},Q=(t,a)=>{M(o=>({...o,[t]:a}))},X=t=>{N(a=>{const o=[...a,t];return localStorage.setItem("deliveryData",JSON.stringify(o)),o})},j=(t,a)=>{a==="success"?i.success(t):a==="warning"?i.warning(t):a==="error"?i.error(t):a==="info"&&i.info(t)},E=()=>{H(!0),window.removeEventListener("click",E)};n.useEffect(()=>{window.addEventListener("click",E);const t=()=>{y.get("/get-pump-status").then(s=>{const l=s.data;B(l);const r=l.some(D=>D.Data.NozzleUp);_&&(r&&!b?(m.current&&(m.current.loop=!0,m.current.play().catch(D=>{console.error("Error playing sound:",D)})),w(!0)):!r&&b&&(m.current&&(m.current.pause(),m.current.currentTime=0),w(!1)))}).catch(s=>{console.error("Error fetching pump status:",s)})},a=()=>{y.get("/get-mop").then(s=>{V(s.data.data)}).catch(s=>{console.error("Error fetching MOP list:",s)})};t(),a();const o=setInterval(t,500);return()=>clearInterval(o)},[b,_]);const Y=async t=>{const a=parseFloat(v.replace("₱","").replace(",",""));if(v===""||a<=0){i.warning("Please enter amount to pay");return}const o=JSON.parse(localStorage.getItem("transaction"))||{subtotal:parseFloat(h),payments:[],remainingBalance:parseFloat(h)},s=o.remainingBalance-a;if(o.payments.push({mopName:t.MOP_Name,amount:a}),o.remainingBalance=s,localStorage.setItem("transaction",JSON.stringify(o)),t.MOP_Ref==="3"){x(!0);return}if(s>=0)s===0?await P():p(`Amount Due: ₱${s.toFixed(2)}`);else{const l=Math.abs(s).toFixed(2);i.success(`Change: ₱${l}`),p(`Change: ₱${l}`),o.remainingBalance=0,localStorage.setItem("transaction",JSON.stringify(o)),await P()}},h=u.reduce((t,a)=>t+parseFloat(a.Amount||0),0).toFixed(2),[Z,k]=n.useState({change:0,mopNames:[],mopPayments:[],deliveryData:[]}),ee=(t,a)=>{if(f==null){i.error("Please select an item to apply discount");return}if(t.discount_id>=1&&t.discount_id<=4){i.info("Discount not applicable");return}const o=u.map(s=>{if(s.Delivery_ID===f){if(s.DiscountedAmount)return i.info("Discount already applied to this item."),s;let l=0;switch(t==null?void 0:t.discount_type){case"1":l=parseFloat(s.Amount)*parseFloat(a==null?void 0:a.preset_value)/100;break;case"2":l=parseFloat(s.Volume)*parseFloat(a==null?void 0:a.preset_value);break;case"3":l=parseFloat(a==null?void 0:a.preset_value);break}const r=parseFloat(s.Amount)-l;return{...s,OriginalAmount:s.Amount,Amount:r.toFixed(2),DiscountedAmount:l.toFixed(2),PresetName:a==null?void 0:a.preset_name,DiscountType:t==null?void 0:t.discount_type,PresetValue:a==null?void 0:a.preset_value}}return s});N(o),i.success("Discount applied.")},P=async()=>{const t=JSON.parse(localStorage.getItem("transaction"));if(!t){i.error("No transaction found");return}if(I&&I.MOP_Ref==="3"&&(!cardNumber||!approvalCode||!cardHolderName)){i.error("Please provide complete card details."),x(!0);return}const a=t.payments.reduce((s,l)=>s+l.amount,0),o=Math.max(0,a-t.subtotal).toFixed(2);try{const l=(await y.post("/store-transactions",{subtotal:t.subtotal,taxTotal:t.subtotal/1.12*.12,...parseFloat(o)>0&&{change:parseFloat(o)},mopNames:t.payments.map(r=>r.mopName.trim()),mopPayments:t.payments,deliveryIds:u.map(r=>({Delivery_ID:r.Delivery_ID,Pump:r.Pump,Nozzle:r.Nozzle,Volume:r.Volume,Price:r.Price,Amount:r.Amount,OriginalAmount:r.OriginalAmount,DiscountedAmount:r.DiscountedAmount,DiscountType:r.DiscountType,PresetName:r.PresetName,PresetValue:r.PresetValue,FuelGradeName:r.FuelGradeName})),customer:{name:c.name,address:c.address,tin:c.tin,businessStyle:c.businessStyle},cardDetails:{cardNumber:d.cardNumber,approvalCode:d.approvalCode,cardHolderName:d.cardHolderName}})).data.transaction;l?(localStorage.setItem("transactionId",l),i.success("Transaction saved"),F(!0),$(0),p("Transaction Complete"),k({change:parseFloat(o),mopNames:t.payments.map(r=>r.mopName),mopPayments:t.payments,deliveryData:u}),localStorage.removeItem("transaction"),M({}),A({}),z(l)):i.error("Error retrieving transaction ID")}catch{i.error("Error saving transaction")}},z=async t=>{if(!t){i.info("Please transact first");return}try{const o=(await y.get(`/print-receipt/${t}`)).data}catch{i.error("Error fetching receipt data")}};return e.jsxs(e.Fragment,{children:[e.jsx(te,{title:"Home"}),e.jsx("audio",{ref:m,src:"assets/audio/nozzle-status-sound.wav"}),e.jsxs("main",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 p-2 h-[100vh] bg-gradient-to-bl from-blue-100 via-transparent dark:from-blue-950 dark:via-transparent",children:[e.jsxs(g,{className:"dark:bg-gray-900 p-2",children:[e.jsx("div",{children:e.jsxs(g,{className:"max-w-full h-full",children:[e.jsxs(ae,{className:"justify-between",children:[e.jsx(pe,{}),e.jsx(fe,{})]}),e.jsx(se,{className:"justify-between",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"w-[70%] h-[65px] bg-slate-200 rounded-lg shadow-sm relative",children:e.jsx(re,{autoClose:2e3,hideProgressBar:!1,newestOnTop:!1,closeOnClick:!0,pauseOnFocusLoss:!1,draggable:!0,pauseOnHover:!1,theme:"light",transition:oe,style:{position:"absolute",top:0,right:0,bottom:0,left:0,width:"100%"}})}),e.jsx(de,{}),e.jsx(xe,{})]})})]})}),e.jsx(ve,{y:3}),e.jsx("div",{className:"flex-grow",children:e.jsx(ye,{deliveryData:u,setSelectedRow:C,subtotal:h,transactionSaved:U,transactionSummary:Z})}),e.jsx("div",{children:e.jsxs(g,{className:"w-full gap-2 p-2",children:[e.jsx(Ne,{variant:"bordered",classNames:{input:["text-black text-2xl font-bold text-right"]},value:v,isReadOnly:!0,size:"lg"}),e.jsx(le,{setDeliveryData:N,deliveryData:u,setSelectedRow:C,selectedRow:f,subtotal:h,onToast:j,buttons:ce,setInputValue:p,setTransactionSummary:k,setTransactionSaved:F,setCustomerModalOpen:T,setTotalPaid:L,totalPaid:J,handlePrintReceipt:z})]})})]}),e.jsx(g,{className:"dark:bg-gray-900 p-2",children:e.jsx("div",{className:"flex w-full flex-col",children:e.jsxs(be,{"aria-label":"Pumps",fullWidth:!0,children:[e.jsx(S,{title:e.jsx("p",{className:"font-extrabold",children:"PUMPS"}),children:O.length===0?e.jsxs("div",{className:"col-span-4 flex flex-col items-center justify-center py-12 text-xl font-extrabold text-center text-red-500",children:[e.jsx(ne,{className:"text-7xl"}),e.jsx("p",{children:"No pumps connected!"})]}):e.jsx("div",{className:"overflow-y-auto scrollbar-hide max-h-screen p-1",children:e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2",children:O.map(t=>e.jsx(me,{pump:t,handleAppendDeliveryData:X,onToast:j},t.Id))})})},"pumps"),e.jsx(S,{title:e.jsx("p",{className:"font-extrabold",children:"MOP"}),children:e.jsx(ie,{mopList:G,onSelectMOP:Y,onApplyDiscount:ee})},"mop"),e.jsx(S,{title:e.jsx("p",{className:"font-extrabold",children:"REPORTS"}),children:e.jsx(Se,{})},"reports"),e.jsx(S,{title:e.jsx("p",{className:"font-extrabold",children:"CONFIG"}),children:e.jsx(he,{onToast:j})},"config")]})})})]}),e.jsx(ue,{isOpen:W,onClose:R,onCustomerDataChange:Q,customerName:c.name,customerAddress:c.address,customerTIN:c.tin,customerBusinessStyle:c.businessStyle,onSave:K}),e.jsx(ge,{isOpen:q,onOpenChange:x,cardDetails:d,setCardDetails:A,onSave:async()=>{if(!d.approvalCode){i.error("Please fill required fields.");return}x(!1),await P()}})]})}export{Tt as default};
